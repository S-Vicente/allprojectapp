<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AllProjects</title>
  <style>
    :root {
      --bg-primary:   #DDE0BD;
      --bg-secondary: #B7E1E1;
      --surface:      #B6A39E;
      --text-primary:   #EBEBEB;
      --text-secondary: #404664;
      --accent:         var(--surface);
      --shadow-color:   rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family:sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      display:flex; flex-direction:column; height:100vh;
    }
    header {
      background:var(--surface);
      display:flex; justify-content:space-between; align-items:center;
      padding:.5rem 1rem; position:sticky; top:0; z-index:10;
    }
    .header-left, .header-right {
      display:flex; align-items:center; gap:.5rem;
    }
    #page-title {
      font-size:1.2rem;
      color:var(--text-secondary);
    }
    .btn-primary {
      background:var(--bg-secondary);
      color:var(--text-secondary);
      border:none; border-radius:8px;
      padding:.5rem 1rem; cursor:pointer;
    }
    .btn-primary:hover { background:var(--accent); }
    #menu-btn {
      background:none; border:none;
      font-size:1.5rem; cursor:pointer;
    }
    .menu {
      position:absolute; right:1rem; top:3rem;
      background:white; border:1px solid var(--text-secondary);
      border-radius:6px; box-shadow:0 2px 6px var(--shadow-color);
      display:none;
    }
    .menu.visible { display:block; }
    .menu ul { list-style:none; margin:0; padding:0; }
    .menu li { padding:.5rem 1rem; cursor:pointer; }
    .menu li:hover { background: var(--bg-secondary); }
    main {
      flex:1; overflow-y:auto; padding:1rem;
    }
    .task-card {
      background:var(--surface);
      border-radius:12px;
      padding:.75rem; margin-bottom:.75rem;
      display:flex; align-items:center; gap:.5rem;
      box-shadow:0 2px 6px var(--shadow-color);
    }
    .task-card span:last-of-type { flex:1; }
    .mark-icon { font-size:1.2rem; }
    .task-card button { background:none; border:none; font-size:1.2rem; cursor:pointer; }
    .task-card input[type="checkbox"] { transform: scale(1.2); }
    .progress-bar { width:80px; margin:0 .5rem; vertical-align:middle; }
    .hidden { display:none; }
  </style>
</head>
<body onclick="document.getElementById('menu').classList.remove('visible')">
  <header>
    <div class="header-left">
      <button id="back-to-projects" class="btn-primary hidden">‚Üê</button>
      <h1 id="page-title">AllProjects</h1>
    </div>
    <div class="header-right">
      <button id="add-project" class="btn-primary">+ New Project</button>
      <button id="add-task" class="btn-primary hidden">+ New Task</button>
      <button id="menu-btn"
        onclick="event.stopPropagation(); document.getElementById('menu').classList.toggle('visible')"
      >‚ãÆ</button>
    </div>
    <div id="menu" class="menu" onclick="event.stopPropagation()">
      <ul>
        <li id="m-edit">‚úèÔ∏è Edit</li>
        <li id="m-search">üîç Search</li>
        <li id="m-sort">‚áÖ Ordenate</li>
        <li id="m-export">üì§ Export CSV</li>
        <li id="m-import">üì• Import CSV</li>
      </ul>
    </div>
  </header>

  <main>
    <div id="project-view"><div id="project-list"></div></div>
    <div id="task-view" class="hidden"><div id="task-list"></div></div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // refer√™ncias
    const refs = {
      menuBtn:       document.getElementById("menu-btn"),
      menu:          document.getElementById("menu"),
      addProj:       document.getElementById("add-project"),
      addTask:       document.getElementById("add-task"),
      backBtn:       document.getElementById("back-to-projects"),
      titleEl:       document.getElementById("page-title"),
      projList:      document.getElementById("project-list"),
      taskList:      document.getElementById("task-list"),
      projView:      document.getElementById("project-view"),
      taskView:      document.getElementById("task-view"),
      editMenu:      document.getElementById("m-edit"),
      searchMenu:    document.getElementById("m-search"),
      sortMenu:      document.getElementById("m-sort"),
      exportMenu:    document.getElementById("m-export"),
      importMenu:    document.getElementById("m-import")
    };

    let projects = JSON.parse(localStorage.getItem("projects")||"[]");
    let currentProjectIndex = null, sortAsc = true;

    const save = () => localStorage.setItem("projects", JSON.stringify(projects));
    const getProjIdxs = ()=> projects.map((_,i)=>i);
    const getTaskIdxs = ()=> projects[currentProjectIndex].tasks.map((_,i)=>i);

    function renderProjects(idxs){
      refs.titleEl.textContent="AllProjects";
      refs.backBtn.classList.add("hidden");
      refs.addProj.classList.remove("hidden");
      refs.addTask.classList.add("hidden");
      refs.projView.classList.remove("hidden");
      refs.taskView.classList.add("hidden");
      refs.projList.innerHTML="";
      idxs.forEach(i=>{
        const p=projects[i], card=document.createElement("div");
        card.className="task-card";
        card.onclick=()=>{currentProjectIndex=i; renderTasks(getTaskIdxs());};
        const span=document.createElement("span");
        span.textContent=`${p.name} (${p.tasks.length})`; card.appendChild(span);
        const eb=document.createElement("button");
        eb.innerText="‚úèÔ∏è";
        eb.onclick=e=>{e.stopPropagation(); const n=prompt("Novo nome:",p.name);
          if(n!==null){p.name=n; save(); renderProjects(getProjIdxs());}};
        card.appendChild(eb);
        const db=document.createElement("button");
        db.innerText="üóëÔ∏è";
        db.onclick=e=>{e.stopPropagation();
          if(confirm(`Delete "${p.name}"?`)){projects.splice(i,1); save(); renderProjects(getProjIdxs());}};
        card.appendChild(db);
        refs.projList.appendChild(card);
      });
    }

    function renderTasks(idxs){
      const p=projects[currentProjectIndex];
      refs.titleEl.textContent=p.name;
      refs.backBtn.classList.remove("hidden");
      refs.addProj.classList.add("hidden");
      refs.addTask.classList.remove("hidden");
      refs.projView.classList.add("hidden");
      refs.taskView.classList.remove("hidden");
      refs.taskList.innerHTML="";
      idxs.forEach(i=>{
        const t=p.tasks[i], card=document.createElement("div");
        card.className="task-card";
        const chk=document.createElement("input");
        chk.type="checkbox"; chk.checked=t.tracking;
        chk.onchange=()=>{t.tracking=chk.checked;if(!chk.checked)t.progress=0;
          save(); renderTasks(getTaskIdxs());};
        card.appendChild(chk);
        if(t.mark){const dot=document.createElement("span");
          dot.className="mark-icon"; dot.innerText="‚óè"; dot.style.color=t.mark;
          card.appendChild(dot);}
        const txt=document.createElement("span");
        txt.innerHTML=t.title+(t.datetime?` ‚Äî <small>${new Date(t.datetime).toLocaleString()}</small>`:"");
        card.appendChild(txt);
        const et=document.createElement("button");
        et.innerText="‚úèÔ∏è";
        et.onclick=()=>{
          const nt=prompt("T√≠tulo:",t.title),
                dp=t.datetime?new Date(t.datetime).toISOString().slice(0,16).replace("T",""):"",
                nd=prompt("Data/hora:",dp),
                cp=t.mark||"",
                nc=prompt("Cor:",cp);
          if(nt!==null)t.title=nt;
          if(nd!==null)t.datetime=nd?new Date(nd).toISOString():null;
          if(nc!==null)t.mark=nc.trim()===""?null:nc.trim();
          save(); renderTasks(getTaskIdxs());
        };
        card.appendChild(et);
        if(t.tracking){
          const pr=document.createElement("progress");
          pr.className="progress-bar"; pr.max=100; pr.value=t.progress;
          card.appendChild(pr);
          const up=document.createElement("button");
          up.innerText="üìà";
          up.onclick=()=>{
            const v=parseInt(prompt("Prog (0‚Äì100):",t.progress),10);
            if(!isNaN(v)){t.progress=Math.min(100,Math.max(0,v)); save(); renderTasks(getTaskIdxs());}
          };
          card.appendChild(up);
        }
        const dt=document.createElement("button");
        dt.innerText="üóëÔ∏è";
        dt.onclick=()=>{
          if(confirm(`Delete "${t.title}"?`)){p.tasks.splice(i,1); save(); renderTasks(getTaskIdxs());}
        };
        card.appendChild(dt);
        refs.taskList.appendChild(card);
      });
    }

    renderProjects(getProjIdxs());

    refs.addProj.onclick=()=>{
      const n=prompt("Name of new project:");
      if(n){projects.push({name:n,tasks:[]}); save(); renderProjects(getProjIdxs());}
    };
    refs.backBtn.onclick=()=>{
      currentProjectIndex=null;
      renderProjects(getProjIdxs());
    };
    refs.addTask.onclick=()=>{
      const t=prompt("Title:"), dt=prompt("Date/time or blank:"), mk=prompt("Color or blank:");
      if(!t) return;
      const p=projects[currentProjectIndex];
      p.tasks.push({title:t,datetime:dt?new Date(dt).toISOString():null,tracking:false,progress:0,mark:mk||null});
      save(); renderTasks(getTaskIdxs());
    };

    refs.editMenu.onclick   =()=>alert("Use ‚úèÔ∏è at cards.");
    refs.searchMenu.onclick =()=>{
      const term=prompt("Search:").toLowerCase();
      if(currentProjectIndex===null){
        renderProjects(getProjIdxs().filter(i=>projects[i].name.toLowerCase().includes(term)));
      }else{
        renderTasks(getTaskIdxs().filter(i=>projects[currentProjectIndex].tasks[i].title.toLowerCase().includes(term)));
      }
    };
    refs.sortMenu.onclick=()=>{
      if(currentProjectIndex===null){
        let idxs=getProjIdxs();
        idxs.sort((a,b)=>sortAsc?projects[a].name.localeCompare(projects[b].name,undefined,{numeric:true}):
                                   projects[b].name.localeCompare(projects[a].name,undefined,{numeric:true}));
        renderProjects(idxs);
      }else{
        let idxs=getTaskIdxs();
        idxs.sort((a,b)=>sortAsc?
          projects[currentProjectIndex].tasks[a].title.localeCompare(projects[currentProjectIndex].tasks[b].title,undefined,{numeric:true}):
          projects[currentProjectIndex].tasks[b].title.localeCompare(projects[currentProjectIndex].tasks[a].title,undefined,{numeric:true}));
        renderTasks(idxs);
      }
      sortAsc=!sortAsc;
    };
    refs.exportMenu.onclick=()=>{
      refs.menu.classList.remove("visible");
      let csv="";
      if(currentProjectIndex===null){
        csv="project,task,datetime,progress\n"+projects.flatMap(p=>p.tasks.map(t=>`"${p.name}","${t.title}",${t.datetime||""},${t.progress||0}`)).join("\n");
      }else{
        csv="task,datetime,progress\n"+projects[currentProjectIndex].tasks.map(t=>`"${t.title}",${t.datetime||""},${t.progress||0}`).join("\n");
      }
      const blob=new Blob([csv],{type:"text/csv"}), a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download=currentProjectIndex===null?"allprojects.csv":`project_${projects[currentProjectIndex].name}.csv`;
      document.body.appendChild(a);a.click();document.body.removeChild(a);
    };
    refs.importMenu.onclick=()=>alert("Importa√ß√£o pendente.");
  });
  </script>
</body>
</html>
